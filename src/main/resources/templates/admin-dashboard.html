<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/admindashboard.css}" />
    
</head>
<body>
    <div class="dashboard">
      <div class="header">
        <h1>Admin Dashboard</h1>
        <div class="button-group">
          <a th:href="@{/employees/add}" class="button">Add Member</a>
          <a href="/logout" class="button">Logout</a>
        </div>
      </div>
      <table>
        <thead>
          <tr>
                    <th>Employment Code</th>
                    <th>Name</th>
                    <th>Company Email</th>
                    <th>Manager Name</th>
                    <th>Actions</th>
                </tr>
        </thead>
        <tbody>
                <tr th:each="employee : ${employees}">
                    <td th:text="${employee.employmentCode}"></td>
                    <td th:text="${employee.fullName}"></td>
                    <td th:text="${employee.companyMail}"></td>
                    <td th:text="${employee.reportingManager}"></td>
                    <td>
                        <a class="edit-btn" data-id="${employee.id}" th:href="@{/employees/edit/{id}(id=${employee.id})}">Edit</a>
                        <form class="delete-btn" data-id="${employee.id}" th:action="@{/employees/delete/{id}(id=${employee.id})}" method="post" style="display:inline;">
                            <button type="submit">Delete</button>
                        </form>
                    </td>
                </tr>
            </tbody>

      </table>
    </div>
    <script>
    	document.addEventListener("DOMContentLoaded",  () => {
        console.log("DOM fully loaded and parsed");

        // Delete button logic - Confirmation and success message
        document.querySelectorAll('.delete-btn').forEach(form => {
            console.log("Attaching listener to delete button");

            form.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent form submission and page reload
                console.log("Delete button clicked");

                // Show confirmation dialog
                const isConfirmed = confirm("Are you sure you want to delete this employee?");
                if (isConfirmed) {
                    console.log("User confirmed deletion");

                    const employeeId = form.getAttribute('data-id'); // Get the employee ID from the form's data attribute
                    console.log("Employee ID:", employeeId);

                    try {
                        const response = await fetch(`/employees/delete/${employeeId}`, {
                            method: 'POST', // Ensure Spring Boot backend accepts this method
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + localStorage.getItem("token") 
                            }
                        });

                        if (response.ok) {
                            alert("Employee deleted successfully!");
                            // Remove the row from the table without refreshing the page
                            form.closest('tr').remove();
                        } else {
                            alert("Error deleting employee. Please try again.");
                            console.error('Failed to delete employee');
                        }
                    } catch (error) {
                        console.error('Error deleting employee:', error);
                        alert("Error deleting employee. Please try again.");
                    }
                } else {
                    // User canceled the deletion
                    console.log("User canceled deletion");
                }
            });
        });

        // Logout logic - clear localStorage
        document.querySelector('.button-group a[href="/logout"]').addEventListener('click', () => {
            localStorage.clear(); // Clear user data from localStorage
        });

        // Edit button logic - Redirect to edit page
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', () => {
                const employeeId = button.getAttribute('data-id');
                window.location.href = `/edit/${employeeId}`; // Redirect to the edit page
            });
        });
    	})
    	
</script>

  </body>
</html>
