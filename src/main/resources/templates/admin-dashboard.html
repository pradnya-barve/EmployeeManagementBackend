<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/admindashboard.css}" />
    
</head>
<body>
    <div class="dashboard">
      <div class="header">
        <h1>Admin Dashboard</h1>
        <div class="button-group">
          <a th:href="@{/employees/add}" class="button">Add Member</a>
          <a href="/logout" class="button">Logout</a>
        </div>
      </div>
      <table>
        <thead>
          <tr>
                    <th>Employment Code</th>
                    <th>Name</th>
                    <th>Company Email</th>
                    <th>Manager Name</th>
                    <th>Actions</th>
                </tr>
        </thead>
        <tbody>
                <tr th:each="employee : ${employees}">
                    <td th:text="${employee.employmentCode}"></td>
                    <td th:text="${employee.fullName}"></td>
                    <td th:text="${employee.companyMail}"></td>
                    <td th:text="${employee.reportingManager}"></td>
                    <td>
                        <a class="edit-btn" data-id="${employee.id}" th:href="@{/employees/edit/{id}(id=${employee.id})}">Edit</a>
                        <form class="delete-btn" data-id="${employee.id}" th:action="@{/employees/delete/{id}(id=${employee.id})}" method="post" style="display:inline;">
                            <button type="submit">Delete</button>
                        </form>
                    </td>
                </tr>
            </tbody>

      </table>
    </div>
    <script>
    document.addEventListener("DOMContentLoaded", async () => {
    	
    
        document.querySelector('.button-group a[href="/logout"]').addEventListener('click', () => {
            localStorage.clear(); // Clear user data from localStorage
        });
        
     // Edit button logic - Redirect to edit page
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', () => {
                const employeeId = button.getAttribute('data-id');
                window.location.href = `/edit/${employeeId}`; // Redirect to the edit page
            });
        });

        // Delete button logic - Confirmation and success message
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', async () => {
                const employeeId = button.getAttribute('data-id');
                
                // Show confirmation dialog
                if (confirm("Are you sure you want to delete this employee?")) {
                    try {
                        const response = await fetch(`/employees/delete/${employeeId}`, {
                            method: 'POST', // Ensure your Spring Boot backend accepts this method
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + localStorage.getItem("token") 
                            }
                        });

                        if (response.ok) {
                            alert("Employee deleted successfully!"); // Show success popup
                            // Optionally, remove the row from the table without refreshing the page
                            button.closest('tr').remove();
                        } else {
                            console.error('Failed to delete employee');
                            alert("Error deleting employee. Please try again.");
                        }
                    } catch (error) {
                        console.error('Error deleting employee:', error);
                        alert("Error deleting employee. Please try again.");
                    }
                }
            });
        });



        // Fetch employee data from backend
        try {
            const response = await fetch('http://localhost:8080/api/employees', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    // Add authorization header if needed
                    'Authorization': 'Bearer ' + localStorage.getItem("token") 
                }
            });

            if (response.ok) {
                const employees = await response.json();
                const tbody = document.querySelector('tbody');
                employees.forEach(employee => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${employee.id}</td>
                        <td>${employee.name}</td>
                        <td>
                            <a href="/edit/${employee.id}" class="button">Edit</a>
                            <a href="/delete/${employee.id}" class="button">Delete</a>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                console.error('Failed to load employees');
            }
        } catch (error) {
            console.error('Error fetching employee data:', error);
        }
    });

    </script>
  </body>
</html>
